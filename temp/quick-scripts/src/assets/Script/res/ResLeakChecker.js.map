{"version":3,"sources":["assets/Script/res/ResLeakChecker.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["/**\r\n * 资源泄露检查类，可以用于跟踪资源的引用情况\r\n * \r\n * 2021-1-31 by 宝爷\r\n */\r\n\r\nimport { ResUtil } from \"./ResUtil\";\r\n\r\nexport type FilterCallback = (asset: cc.Asset) => boolean;\r\n\r\nexport class ResLeakChecker {\r\n    public resFilter: FilterCallback = null;    // 资源过滤回调\r\n    private _checking: boolean = false;\r\n    private traceAssets: Set<cc.Asset> = new Set<cc.Asset>();\r\n\r\n    /**\r\n     * 检查该资源是否符合过滤条件\r\n     * @param url \r\n     */\r\n    public checkFilter(asset: cc.Asset): boolean {\r\n        if (!this._checking) {\r\n            return false;\r\n        }\r\n        if (this.resFilter) {\r\n            return this.resFilter(asset);\r\n        }\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 对资源进行引用的跟踪\r\n     * @param asset \r\n     */\r\n    public traceAsset(asset: cc.Asset) {\r\n        if (!this.checkFilter(asset)) {\r\n            return;\r\n        }\r\n        if (!this.traceAssets.has(asset)) {\r\n            asset.addRef();\r\n            this.extendAsset(asset);\r\n            this.traceAssets.add(asset);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 扩展asset，使其支持引用计数追踪\r\n     * @param asset \r\n     */\r\n    public extendAsset(asset: cc.Asset) {\r\n        let addRefFunc = asset.addRef;\r\n        let decRefFunc = asset.decRef;\r\n        let traceMap = new Map<string, number>();\r\n        asset['@traceMap'] = traceMap;\r\n        asset.addRef = function (): cc.Asset {\r\n            let stack = ResUtil.getCallStack(1);\r\n            let cnt = traceMap.has(stack) ? traceMap.get(stack) + 1 : 1;\r\n            traceMap.set(stack, cnt);\r\n            return addRefFunc.apply(asset, arguments);\r\n        }\r\n\r\n        asset.decRef = function (): cc.Asset {\r\n            let stack = ResUtil.getCallStack(1);\r\n            let cnt = traceMap.has(stack) ? traceMap.get(stack) + 1 : 1;\r\n            traceMap.set(stack, cnt);\r\n            return decRefFunc.apply(asset, arguments);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 还原asset，使其恢复默认的引用计数功能\r\n     * @param asset \r\n     */\r\n    public resetAsset(asset: cc.Asset) {\r\n        if (asset['@traceMap']) {\r\n            delete asset.addRef;\r\n            delete asset.decRef;\r\n            delete asset['@traceMap'];\r\n        }\r\n    }\r\n\r\n    public untraceAsset(asset: cc.Asset) {\r\n        if (this.traceAssets.has(asset)) {\r\n            this.resetAsset(asset);\r\n            asset.decRef();\r\n            this.traceAssets.delete(asset);\r\n        }\r\n    }\r\n\r\n    public startCheck() { this._checking = true; }\r\n    public stopCheck() { this._checking = false; }\r\n    public getTraceAssets(): Set<cc.Asset> { return this.traceAssets; }\r\n\r\n    public reset() {\r\n        this.traceAssets.forEach(element => {\r\n            this.resetAsset(element);\r\n            element.decRef();\r\n        });\r\n        this.traceAssets.clear();\r\n    }\r\n\r\n    public dump() {\r\n        this.traceAssets.forEach(element => {\r\n            let traceMap: Map<string, number> = element['@traceMap'];\r\n            if (traceMap) {\r\n                traceMap.forEach((key, value) => {\r\n                    console.log(`${key} : ${value} `);                    \r\n                });\r\n            }\r\n        })\r\n    }\r\n}\r\n"]}